<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<input type="file" id="fileInput" style="display: none;" accept=".po">
		<title>Bulk PO File Translator</title>
		<style>
			body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			line-height: 1.6;
			color: #333;
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
			background-color: #f5f5f5;
			}
			
			h1 {
			color: #2c3e50;
			text-align: center;
			margin-bottom: 30px;
			}
			
			.container {
			display: flex;
			flex-direction: column;
			gap: 20px;
			}
			
			/* Position sections in the grid */
			.section:nth-child(1) { /* Original PO File */
			grid-column: 1;
			grid-row: 1;
			}
			
			.section:nth-child(2) { /* Translation Table */
			grid-column: 2;
			grid-row: 1;
			}
			
			.section:nth-child(3) { /* Translated PO File */
			grid-column: 1 / span 2; /* Spans both columns */
			grid-row: 2;
			}
			
			.section {
			min-width: 0; /* Allows columns to shrink properly */
			overflow: auto; /* Adds scroll if content is too wide */
			background: white;
			border-radius: 8px;
			padding: 20px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
			}
			
			textarea {
			width: 100%;
			height: 300px;
			padding: 10px;
			border: 1px solid #ddd;
			border-radius: 4px;
			font-family: monospace;
			resize: vertical;
			}
			
			.controls {
			display: flex;
			gap: 10px;
			margin: 20px 0;
			flex-wrap: wrap;
			}
			
			select {
			padding: 8px 12px;
			border-radius: 4px;
			border: 1px solid #ddd;
			flex-grow: 1;
			background: white;
			}
			
			button {
			background-color: #3498db;
			color: white;
			border: none;
			padding: 10px 20px;
			border-radius: 4px;
			cursor: pointer;
			font-weight: bold;
			transition: background-color 0.3s;
			}
			
			button:hover {
			background-color: #2980b9;
			}
			
			button:disabled {
			background-color: #95a5a6;
			cursor: not-allowed;
			}
			
			.loading {
			display: none;
			text-align: center;
			margin: 20px 0;
			}
			
			.spinner {
			border: 4px solid rgba(0, 0, 0, 0.1);
			border-radius: 50%;
			border-top: 4px solid #3498db;
			width: 30px;
			height: 30px;
			animation: spin 1s linear infinite;
			margin: 0 auto;
			}
			
			@keyframes spin {
			0% { transform: rotate(0deg); }
			100% { transform: rotate(360deg); }
			}
			
			.instructions {
			background: #e8f4fc;
			padding: 15px;
			border-radius: 8px;
			margin-bottom: 20px;
			}
			
			.footer {
			text-align: center;
			margin-top: 40px;
			color: #7f8c8d;
			font-size: 0.9em;
			}
			
			.stats {
			background: #e8f4fc;
			padding: 10px;
			border-radius: 4px;
			margin-top: 10px;
			font-size: 0.9em;
			}
			
			.translation-pairs {
			margin-top: 20px;
			border-collapse: collapse;
			width: 100%;
			}
			
			.translation-pairs th, .translation-pairs td {
			border: 1px solid #ddd;
			padding: 8px;
			text-align: left;
			vertical-align: top;
			}
			
			.translation-pairs th {
			background-color: #f2f2f2;
			}
			
			.translation-pairs tr:nth-child(even) {
			background-color: #f9f9f9;
			}
			
			.translation-pairs textarea {
			height: 100px;
			width: 100%;
			box-sizing: border-box;
			}
			
			.progress-container {
			width: 100%;
			background-color: #eee;
			border-radius: 4px;
			margin: 10px 0;
			position: relative;
			}
			
			.progress-bar {
			height: 20px;
			background-color: #3498db;
			border-radius: 4px;
			width: 0%;
			transition: width 0.3s;
			}
			
			.progress-text {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			font-size: 12px;
			color: #333;
			}
			
			.table-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 10px;
			flex-wrap: wrap;
			gap: 10px;
			}
			
			.table-actions {
			display: flex;
			gap: 10px;
			}
			
			.table-actions button {
			padding: 5px 10px;
			font-size: 0.9em;
			}
			
			.error-marker {
			background-color: #ffdddd;
			border-left: 3px solid #ff0000;
			padding-left: 5px;
			}
			
			.warning-marker {
			background-color: #fff3cd;
			border-left: 3px solid #ffc107;
			padding-left: 5px;
			}
			
			/* Context column styling */
			.context-cell {
			font-size: 0.85em;
			max-width: 200px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
			color: #666;
			}
			
			/* Make table scrollable */
			.translation-table-container {
			max-height: 500px;
			overflow-y: auto;
			border: 1px solid #ddd;
			border-radius: 4px;
			}
			
			/* different types of comments in the context cell */
			.reference {
			color: #0066cc;
			}
			.comment {
			color: #009933;
			}
			.other-comment {
			color: #666666;
			}
			/* Improved table styling */
			.translation-table {
			width: 100%;
			border-collapse: collapse;
			border: 2px solid #2c3e50;
			}
			
			.translation-table th, 
			.translation-table td {
			border: 1px solid #bbb;
			padding: 10px;
			vertical-align: top;
			}
			
			.translation-table th {
			background-color: #2c3e50;
			color: white;
			font-weight: bold;
			position: sticky;
			top: 0;
			z-index: 10;
			}
			
			.translation-table tr:nth-child(even) {
			background-color: #f8f9fa;
			}
			
			.translation-table tr:hover {
			background-color: #e9f7fe;
			}
			
			/* Better handling of long content */
			.context-cell, 
			.original-text, 
			.translation-cell {
			max-height: 150px;
			overflow-y: auto;
			white-space: pre-wrap;
			word-break: break-word;
			}
			
			.original-text {
			max-width: 300px;
			font-family: monospace;
			}
			
			.translation-cell {
			max-width: 300px;
			font-family: monospace;
			}
			
			/* Status indicators */
			.status {
			text-align: center;
			min-width: 100px;
			}
			
			.translated {
			background-color: #e8f5e9 !important;
			}
			
			.untranslated {
			background-color: #ffebee !important;
			}
			
			.obsolete {
			background-color: #f5f5f5 !important;
			color: #9e9e9e;
			}
			/* Fuzzy Rows */
			tr.fuzzy {
			background-color: #fff9db; /* Light yellow background */
			}
			
			tr.fuzzy td {
			border-left: 3px solid #ffd43b; /* Yellow accent border */
			}
			
			/* Scrollable table container */
			.translation-table-container {
			max-height: 500px;
			overflow-y: auto;
			border: 1px solid #ddd;
			border-radius: 4px;
			margin-top: 10px;
			position: relative; /* Create new stacking context */
			z-index: 1; /* Lower than dropdown */
			}
			/* plural forms display */
			.plural-translations {
			display: flex;
			flex-direction: column;
			gap: 5px;
			}
			
			.plural-form {
			display: flex;
			align-items: center;
			gap: 5px;
			}
			
			.plural-index {
			font-weight: bold;
			color: #2c3e50;
			}
			.plural-header {
			display: flex;
			justify-content: space-between;
			margin-bottom: 4px;
			}
			
			.plural-explanation {
			font-size: 0.85em;
			color: #7f8c8d;
			font-style: italic;
			text-align: right;
			flex-grow: 1;
			padding-left: 10px;
			}
			.plural-text {
			flex-grow: 1;
			padding: 3px;
			border: 1px solid #ddd;
			border-radius: 3px;
			min-height: 20px;
			}
			
			.original-plural {
			font-family: monospace;
			max-width: 200px;
			overflow: auto;
			white-space: pre-wrap;
			word-break: break-word;
			}
			
			.plural-translations-cell {
			max-width: 300px;
			overflow: auto;
			}
			/* dropdown */
			.dropdown {
			position: relative;
			display: inline-block;
			z-index: 1000;
			}
			
			.dropdown-content {
			display: none;
			position: absolute;
			background-color: #f9f9f9;
			min-width: 200px;
			box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
			z-index: 1001;
			border-radius: 4px;
			}
			
			.dropdown-content a {
			color: #333;
			padding: 12px 16px;
			text-decoration: none;
			display: block;
			border-bottom: 1px solid #eee;
			font-size: 0.9em;
			}
			
			.dropdown-content a:hover {
			background-color: #3498db;
			color: white;
			}
			
			.dropdown:hover .dropdown-content {
			display: block;
			}
			
			#fuzzyAllBtn {
			background-color: #ffc107;
			}
			
			#unfuzzyAllBtn {
			background-color: #17a2b8;
			}
			
			#emptyShellBtn {
			background-color: #dc3545;
			}
			
			#fuzzyAllBtn:hover {
			background-color: #e0a800;
			}
			
			#unfuzzyAllBtn:hover {
			background-color: #138496;
			}
			
			#emptyShellBtn:hover {
			background-color: #c82333;
			}
			/* Add modal styles */
			.modal {
			display: none;
			position: fixed;
			z-index: 1002;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			overflow: auto;
			background-color: rgba(0,0,0,0.4);
			}
			
			.modal-content {
			background-color: #fefefe;
			margin: 10% auto;
			padding: 20px;
			border: 1px solid #888;
			width: 80%;
			max-width: 800px;
			border-radius: 8px;
			box-shadow: 0 4px 8px rgba(0,0,0,0.2);
			}
			
			.close {
			color: #aaa;
			float: right;
			font-size: 28px;
			font-weight: bold;
			cursor: pointer;
			}
			
			.close:hover,
			.close:focus {
			color: black;
			text-decoration: none;
			}
			
			/* Analysis report styles */
			.report-section {
			margin-bottom: 20px;
			}
			
			.report-table {
			width: 100%;
			border-collapse: collapse;
			margin: 10px 0;
			}
			
			.report-table th, .report-table td {
			border: 1px solid #ddd;
			padding: 8px;
			text-align: left;
			}
			
			.report-table th {
			background-color: #f2f2f2;
			}
			
			.progress-container {
			height: 20px;
			background-color: #e0e0e0;
			border-radius: 4px;
			margin: 5px 0;
			}
			
			.progress-bar {
			height: 100%;
			border-radius: 4px;
			background-color: #4CAF50;
			text-align: center;
			color: white;
			font-size: 12px;
			line-height: 20px;
			}
			
			.stats-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 15px;
			margin-bottom: 20px;
			}
			
			.stat-card {
			background: #f8f9fa;
			border-radius: 8px;
			padding: 15px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			}
			
			.stat-card h4 {
			margin-top: 0;
			color: #2c3e50;
			}
		</style>
	</head>
	<body>
		<div id="analysisModal" class="modal">
			<div class="modal-content">
				<span class="close">&times;</span>
				<h2>Translation Analysis Report</h2>
				<div id="analysisReport"></div>
			</div>
		</div>
		<h1>Bulk PO File Translator</h1>
		
		<div class="instructions">
			<h3>How to use:</h3>
			<ol>
				<li><strong>Paste your PO file content</strong> in the left textarea (or use the sample provided)</li>
				<li><strong>Select target language</strong> from the dropdown menu</li>
				<li>Click <strong>"Extract Strings"</strong> to parse the PO file and display all translatable strings</li>
				<li><strong>Translate the strings</strong> in the middle column:
					<ul>
						<li>Edit directly in the table cells</li>
						<li>For multi-line strings, preserve the original line breaks</li>
						<li>Special markup (like <code>&lt;header&gt;</code> tags) should be kept intact</li>
						<li>Use <strong>"Upload Translations"</strong> to bulk import translations from a text file</li>
						<li>Use <strong>"Download Original Text"</strong> to export all strings for external translation</li>
					</ul>
				</li>
				<li>Click <strong>"Apply Translations"</strong> to generate the translated PO file</li>
				<li><strong>Review and copy</strong> the translated content from the right textarea or use the download buttons:
					<ul>
						<li><strong>"Upload Input PO"</strong> - Upload a PO file to translate</li>
						<li><strong>"Download Output PO"</strong> - Download the translated PO file</li>
					</ul>
				</li>
			</ol>
			<p><strong>Special features:</strong></p>
			<ul>
				<li>Handles multi-line strings and special PO file formatting</li>
				<li>Preserves metadata headers and comments</li>
				<li>Supports obsolete messages (marked with <code>#~</code>)</li>
				<li>Includes validation for common PO file issues</li>
				<li>Bulk import/export capabilities</li>
			</ul>
			<p><strong>Note:</strong> This tool simulates the translation workflow while maintaining proper PO file structure.</p>
		</div>
		
		<div class="container">
			<div class="section">
				<h3>Original PO File</h3>
				<textarea id="sourceText" placeholder="Paste your PO file content here..."></textarea>
				<div class="stats" id="sourceStats"></div>
			</div>
			
			<div class="section">
				<div class="table-header">
					<h3>Translation Table</h3>
					<div class="table-actions">
						<div class="dropdown">
							<button id="downloadOriginalBtn" disabled class="dropbtn">Download Original Text</button>
							<div class="dropdown-content">
								<a href="#" id="downloadAll">All Strings</a>
								<a href="#" id="downloadUntranslated">Only Untranslated</a>
								<a href="#" id="downloadTranslated">Only Translated</a>
								<a href="#" id="downloadFuzzy">Only Fuzzy</a>
								<a href="#" id="downloadObsolete">Only Obsolete</a>
								<a href="#" id="downloadwithContext">With Context</a>
								<a href="#" id="downloadCSV">CSV Format</a>
							</div>
						</div>
						<button id="uploadTranslationsBtn">Upload Translations</button>
					</div>
				</div>
				<div id="translationTableContainer">
					<p>Click "Extract Strings" to populate the translation table</p>
				</div>
			</div>
			
			<div class="section">
				<h3>Translated PO File</h3>
				<textarea id="translatedText" readonly placeholder="Translation will appear here..."></textarea>
				<div class="stats" id="translatedStats"></div>
			</div>
		</div>
		
		<div class="controls">
			<select id="targetLang">
				<option value="en_GB">British English</option>
				<option value="it">Italian</option>
				<option value="cs">Czech</option>
				<option value="de">German</option>
				<option value="ar">Arabic</option>
				<option value="ja">Japanese</option>
				<option value="sk">Slovak</option>
				<option value="zh_CN">Chinese (Simplified)</option>
				<option value="tr">Turkish</option>
				<option value="fr">French</option>
				<option value="es" selected>Spanish</option>
				<option value="ru">Russian</option>
				<option value="fi">Finnish</option>
				<option value="pt_BR">Brazilian Portuguese</option>
				<option value="zh_TW">Chinese (Taiwan)</option>
				<option value="pl">Polish</option>
				<option value="bg">Bulgarian</option>
				<option value="hu">Hungarian</option>
				<option value="ca">Catalan</option>
				<option value="gl">Galician</option>
				<option value="pt">Portuguese</option>
				<option value="vi">Vietnamese</option>
				<option value="id">Indonesian</option>
				<option value="et">Estonian</option>
				<option value="uk">Ukrainian</option>
				<option value="sv">Swedish</option>
				<option value="lt">Lithuanian</option>
				<option value="sr">Serbian</option>
				<option value="eo">Esperanto</option>
				<option value="da">Danish</option>
				<option value="ko">Korean</option>
				<option value="la">Latin</option>
				<option value="nl">Dutch</option>
				<option value="gd">Scottish Gaelic</option>
				<option value="el">Greek</option>
				<option value="nb_NO">Norwegian</option>
				<option value="en@shaw">English (Shavian characters)</option>
				<option value="ga">Irish</option>
				<option value="racv">RACV Language</option>
				<option value="bn">Bengali</option>
				<option value="lv">Latvian</option>
				<option value="af">Afrikaans</option>
				<option value="he">Hebrew</option>
				<option value="is">Icelandic</option>
				<option value="sl">Slovenian</option>
				<option value="eu">Basque</option>
				<option value="ang@latin">Old English (Latin characters)</option>
				<option value="hr">Croatian</option>
				<option value="ca_ES@valencia">Valencian (Southern Catalan)</option>
				<option value="tl">Filipino</option>
				<option value="grc">Ancient Greek</option>
				<option value="mr">Marathi</option>
				<option value="mk">Macedonian</option>
				<option value="ro">Romanian</option>
				<option value="cy">Welsh</option>
				<option value="es_419">Spanish (Latin American)</option>
				<option value="my">Burmese</option>
			</select>
			
			<button id="extractBtn">Extract Strings</button>
			<button id="applyBtn" disabled>Apply Translations</button>
			<button id="analyzeBtn">Analyze</button>
			<button id="uploadInputBtn">Upload Input PO</button>
			<button id="downloadOutputBtn" disabled>Download Output PO</button>
			<button id="emptyShellBtn">Empty Shell</button>
			<button id="fuzzyAllBtn">Fuzzy All</button>
			<button id="unfuzzyAllBtn">Unfuzzy All</button>
		</div>
		
		<div class="progress-container">
			<div class="progress-bar" id="progressBar"></div>
			<div class="progress-text" id="progressText"></div>
		</div>
		
		<div class="loading" id="loadingIndicator">
			<div class="spinner"></div>
			<p>Processing... Please wait.</p>
		</div>
		
		<div class="footer">
			<p>Bulk PO File Translator | Developper: Mejri Ziad</p>
		</div>
		
		<script>
			document.addEventListener('DOMContentLoaded', function() {
				// DOM Elements
				const sourceText = document.getElementById('sourceText');
				const translatedText = document.getElementById('translatedText');
				const targetLang = document.getElementById('targetLang');
				const extractBtn = document.getElementById('extractBtn');
				const applyBtn = document.getElementById('applyBtn');
				const downloadOriginalBtn = document.getElementById('downloadOriginalBtn');
				const uploadTranslationsBtn = document.getElementById('uploadTranslationsBtn');
				const loadingIndicator = document.getElementById('loadingIndicator');
				const sourceStats = document.getElementById('sourceStats');
				const translationTableContainer = document.getElementById('translationTableContainer');
				const uploadInputBtn = document.getElementById('uploadInputBtn');
				const downloadOutputBtn = document.getElementById('downloadOutputBtn');
				const emptyShellBtn = document.getElementById('emptyShellBtn');
				const fuzzyAllBtn = document.getElementById('fuzzyAllBtn');
				const unfuzzyAllBtn = document.getElementById('unfuzzyAllBtn');
				const analyzeBtn = document.getElementById('analyzeBtn');
				analyzeBtn.addEventListener('click', performAnalysis);
				
				/**
					* Sample PO file content for initial demonstration
					* @constant {string}
				*/
				const samplePoContent = `# Sample PO File
				# Sample PO File
				msgid ""
				msgstr ""
				"Project-Id-Version: Sample Project\n"
				"POT-Creation-Date: 2023-01-01\n"
				"PO-Revision-Date: 2023-01-01\n"
				"Last-Translator: You <you@example.com>\n"
				"Language-Team: \n"
				"Language: en\n"
				"MIME-Version: 1.0\n"
				"Content-Type: text/plain; charset=UTF-8\n"
				"Content-Transfer-Encoding: 8bit\n"
				"Plural-Forms: nplurals=6; plural= n==0 ? 0 : n==1 ? 1 : n==2 ? 2 : n%100>=3 && "
				"n%100<=10 ? 3 : n%100>=11 && n%100<=99 ? 4 : 5;\n"
				"X-Generator: Poedit 3.0\n"
				
				#: sample/file.c:123
				msgid "Hello world"
				msgstr ""
				
				#: sample/file.c:124
				msgid "%d apple"
				msgid_plural "%d apples"
				msgstr[0] ""
				msgstr[1] ""
				msgstr[2] ""
				msgstr[3] ""
				msgstr[4] ""
				msgstr[5] ""
				
				#~ msgid "Old message"
				#~ msgstr "Old translation"
				`;
				
				// Initialize textarea with sample PO content
				sourceText.value = samplePoContent;
				
				const modal = document.getElementById('analysisModal');
				const closeBtn = document.querySelector('.close');
				
				// Add null checks
				if (closeBtn && modal) {
					closeBtn.addEventListener('click', () => modal.style.display = 'none');
					window.addEventListener('click', (e) => {
						if (e.target === modal) modal.style.display = 'none';
					});
					} else {
					console.error('Modal elements not found');
				}
				/**
					* Handles PO content extraction when extract button is clicked
					* @listens extractBtn#click
				*/
				extractBtn.addEventListener('click', function() {
					const poContent = sourceText.value.trim();
					if (!poContent) {
						alert('Please paste PO file content first');
						return;
					}
					
					// Empty Shell functionality
					emptyShellBtn.addEventListener('click', function() {
						if (!window.currentMessages) {
							alert('Please extract strings first');
							return;
						}
						
						showLoading(true);
						setTimeout(() => {
							window.currentMessages.forEach(msg => {
								// Clear translations
								if (msg.hasPlural && Array.isArray(msg.msgstr)) {
									for (let i = 0; i < msg.msgstr.length; i++) {
										msg.msgstr[i] = "";
									}
									} else {
									msg.msgstr = "";
								}
								
								// Remove fuzzy flag
								msg.fuzzy = false;
							});
							
							refreshTranslationTable();
							alert('All translations have been cleared.');
							showLoading(false);
						}, 100);
					});
					// Fuzzy All functionality
					fuzzyAllBtn.addEventListener('click', function() {
						if (!window.currentMessages) {
							alert('Please extract strings first');
							return;
						}
						
						showLoading(true);
						setTimeout(() => {
							window.currentMessages.forEach(msg => {
								// Only mark non-obsolete messages as fuzzy
								if (!msg.isObsolete) {
									msg.fuzzy = true;
								}
							});
							
							refreshTranslationTable();
							showLoading(false);
						}, 100);
					});
					
					// Unfuzzy All functionality
					unfuzzyAllBtn.addEventListener('click', function() {
						if (!window.currentMessages) {
							alert('Please extract strings first');
							return;
						}
						
						showLoading(true);
						setTimeout(() => {
							window.currentMessages.forEach(msg => {
								msg.fuzzy = false;
							});
							
							refreshTranslationTable();
							showLoading(false);
						}, 100);
					});
					fuzzyAllBtn.addEventListener('click', function() {
						if (!window.currentMessages) {
							alert('Please extract strings first');
							return;
						}
						window.currentMessages.forEach(msg => {
							if (!msg.isObsolete) msg.fuzzy = true;
						});
						refreshTranslationTable();
					});
					
					unfuzzyAllBtn.addEventListener('click', function() {
						if (!window.currentMessages) {
							alert('Please extract strings first');
							return;
						}
						window.currentMessages.forEach(msg => {
							msg.fuzzy = false;
						});
						refreshTranslationTable();
					});
					showLoading(true);
					setTimeout(() => {
						try {
							// Capture the returned value
							const pluralForm = logPluralForm(poContent);
							const explanations = explainPluralFormComprehensively(pluralForm);
							window.pluralFormsExplanations = explanations;
							
							const extractionResult = extractPoStrings(poContent);
							displayExtractedStrings(extractionResult);
							applyBtn.disabled = false;
							downloadOriginalBtn.disabled = false;
							} catch (error) {
							console.error('Extraction error:', error);
							alert('Error extracting strings: ' + error.message);
							} finally {
							showLoading(false);
						}
					}, 100);
				});
				
				/**
					* Applies translations to generate new PO file
					* @listens applyBtn#click
				*/
				applyBtn.addEventListener('click', function() {
					if (!window.currentMessages) {
						alert('Please extract strings first');
						return;
					}
					
					showLoading(true);
					setTimeout(() => {
						try {
							const translatedContent = generateTranslatedPo(window.currentMessages, window.currentMetadata);
							translatedText.value = translatedContent;
							downloadOutputBtn.disabled = false;
							
							// Calculate and display translation statistics
							const translatedCount = window.currentMessages.filter(m => m.msgstr && !m.isObsolete).length;
							const totalCount = window.currentMessages.filter(m => !m.isObsolete).length;
							translatedStats.innerHTML = `
						<p>Translated: ${translatedCount}/${totalCount} (${Math.round(translatedCount/totalCount*100)}%)</p>
						<p>Obsolete: ${window.currentMessages.filter(m => m.isObsolete).length}</p>
						`;
						} catch (error) {
						console.error('Generation error:', error);
						alert('Error generating translation: ' + error.message);
						} finally {
						showLoading(false);
						}
						}, 100);
						});
						
						/**
						* Handles PO file upload for source content
						* @listens uploadInputBtn#click
						*/
						uploadInputBtn.addEventListener('click', function() {
						let fileInput = document.getElementById('fileInput');
						if (!fileInput) {
						fileInput = document.createElement('input');
						fileInput.type = 'file';
						fileInput.id = 'fileInput';
						fileInput.style.display = 'none';
						fileInput.accept = '.po';
						document.body.appendChild(fileInput);
						}
						
						fileInput.onchange = function(e) {
						const file = e.target.files[0];
						if (!file) return;
						
						const reader = new FileReader();
						reader.onload = function(e) {
						sourceText.value = e.target.result;
						};
						reader.readAsText(file);
						
						// Reset file input
						fileInput.value = '';
						};
						
						fileInput.click();
						});
						
						/**
						* Downloads translated PO file with language code in filename
						* @listens downloadOutputBtn#click
						*/
						downloadOutputBtn.addEventListener('click', function() {
						if (!translatedText.value) {
						alert('No translated content to download');
						return;
						}
						
						const langCode = targetLang.value;
						const blob = new Blob([translatedText.value], { type: 'text/plain' });
						const url = URL.createObjectURL(blob);
						const a = document.createElement('a');
						a.href = url;
						a.download = `${langCode}.po`;
						document.body.appendChild(a);
						a.click();
						document.body.removeChild(a);
						URL.revokeObjectURL(url);
						});
						
						/**
						* Exports original strings for translation
						* @listens downloadOriginalBtn#click
						*/
						
						const downloadOptions = {
						downloadAll: 'all',
						downloadUntranslated: 'untranslated',
						downloadTranslated: 'translated',
						downloadFuzzy: 'fuzzy',
						downloadObsolete: 'obsolete',
						downloadwithContext: 'withContext',
						downloadCSV: 'csv'
						};
						
						Object.entries(downloadOptions).forEach(([elementId, optionType]) => {
						document.getElementById(elementId).addEventListener('click', function(e) {
						e.preventDefault();
						exportOriginalStrings(optionType);
						});
						});
						function exportOriginalStrings(optionType) {
						if (!window.currentMessages) {
						alert('Please extract strings first');
						return;
						}
						
						let contentParts = [];
						let filteredMessages = window.currentMessages;
						
						// Apply filters based on option type
						switch(optionType) {
						case 'untranslated':
						filteredMessages = filteredMessages.filter(m => !m.msgstr && !m.isObsolete);
						break;
						case 'translated':
						filteredMessages = filteredMessages.filter(m => m.msgstr && !m.isObsolete);
						break;
						case 'fuzzy':
						filteredMessages = filteredMessages.filter(m => m.fuzzy);
						break;
						case 'obsolete':
						filteredMessages = filteredMessages.filter(m => m.isObsolete);
						break;
						case 'withContext':
						// No special filtering, handled in output
						break;
						case 'csv':
						// Handled separately
						break;
						// 'all' falls through to default
						}
						
						// CSV Format
						if (optionType === 'csv') {
						const headers = ['ID', 'Context', 'Original Text', 'Status', 'Fuzzy', 'Translation'];
						const rows = [headers.join(',')];
						
						filteredMessages.forEach(msg => {
						if (msg.msgid === '') return;
						
						const context = [...msg.references, ...msg.comments]
						.map(c => c.replace(/"/g, '""'))
						.join('; ');
						
						const row = [
						`"${msg.id}"`,
						`"${context}"`,
						`"${msg.msgid.replace(/"/g, '""')}"`,
						`"${msg.msgstr ? 'Translated' : msg.isObsolete ? 'Obsolete' : 'Untranslated'}"`,
						`"${msg.fuzzy ? 'Yes' : 'No'}"`,
						`"${(msg.msgstr || '').replace(/"/g, '""')}"`
						];
						
						rows.push(row.join(','));
						});
						
						contentParts = rows;
						} 
						// With Context option - includes references and comments
						else if (optionType === 'withContext') {
						filteredMessages.forEach(msg => {
						if (msg.msgid === '') return;
						contentParts.push(`#${msg.id}`);
						
						// Include context (references and comments)
						msg.references.forEach(ref => contentParts.push(ref));
						msg.comments.forEach(comment => contentParts.push(comment));
						
						contentParts.push(msg.msgid);
						contentParts.push('\n\n==========\n\n');
						});
						}
						// All other options - simple format (no context)
						else {
						filteredMessages.forEach(msg => {
						if (msg.msgid === '') return;
						contentParts.push(`#${msg.id}`);
						contentParts.push(msg.msgid);
						contentParts.push('\n\n==========\n\n');
						});
						}
						
						// Remove trailing separator
						if (contentParts.length > 0) {
						contentParts = contentParts.slice(0, -1);
						}
						
						const content = contentParts.join('\n');
						const extension = optionType === 'csv' ? 'csv' : 'txt';
						const filename = optionType === 'withContext' ? 
						'original_strings_with_context' : 
						`original_strings_${optionType}`;
						
						const blob = new Blob([content], { type: optionType === 'csv' ? 
						'text/csv;charset=utf-8;' : 'text/plain' });
						
						const url = URL.createObjectURL(blob);
						const a = document.createElement('a');
						a.href = url;
						a.download = `${filename}.${extension}`;
						document.body.appendChild(a);
						a.click();
						document.body.removeChild(a);
						URL.revokeObjectURL(url);
						}
						
						/**
						* Processes uploaded translations and applies to current messages
						* @listens uploadTranslationsBtn#click
						*/
						uploadTranslationsBtn.addEventListener('click', function() {
						if (!window.currentMessages) {
						alert('Please extract strings first');
						return;
						}
						
						const input = document.createElement('input');
						input.type = 'file';
						input.accept = '.txt,.po';
						input.onchange = function(e) {
						const file = e.target.files[0];
						if (!file) return;
						
						showLoading(true);
						const reader = new FileReader();
						reader.onload = function(e) {
						try {
						const content = e.target.result;
						const sections = content.split(/\s*==========\s*/);
						const translations = {};
						
						// Parse translation sections
						sections.forEach(section => {
                        const lines = section.split(/\r?\n/).filter(line => line.trim() !== '');
                        if (lines.length === 0) return;
                        
                        const idLine = lines[0];
                        if (!idLine.startsWith('#')) return;
                        
                        const id = idLine.substring(1).trim();
                        const translation = lines.slice(1).join('\n').trim();
                        
                        if (id && translation) {
						translations[id] = translation;
						}
						});
						
						// Apply translations to message objects
						window.currentMessages.forEach(msg => {
                        if (translations[msg.id]) {
						msg.msgstr = translations[msg.id];
						}
						});
						
						// Refresh UI with updated translations
						displayExtractedStrings({
                        messages: window.currentMessages,
                        metadata: window.currentMetadata
						}, true);
						
						alert('Translations uploaded successfully!');
						} catch (error) {
						console.error('Upload error:', error);
						alert('Error processing translations: ' + error.message);
						} finally {
						showLoading(false);
						}
						};
						reader.readAsText(file);
						};
						input.click();
						});
						});
						/**
						* Removes contextual helper prefixes before the '^' character in translations
						* @param {string} translation - The translation string to process
						* @returns {string} Translation without helper prefixes
						*/
						function removeHelperPrefixes(translation) {
						return translation.replace(/^[^^]*\^/, '');
						}
						/**
						* Extracts and logs the plural form from the PO file header
						* @param {string} poContent - The full PO file content
						*/
						function logPluralForm(poContent) {
						const pluralFormMatch = poContent.match(/"Plural-Forms:\s*([\s\S]*?)\\n"/);
						if (pluralFormMatch && pluralFormMatch[1]) {
						const pluralForm = pluralFormMatch[1].replace(/\s*\n\s*"/g, '');
						console.log('Plural-Forms:', pluralForm);
						return pluralForm; // Return the value
						}
						console.log('No plural form found in PO file header');
						return null;
						}
						function explainPluralForm(pluralForm) {
						if (!pluralForm) {
						console.log('No plural form found in PO file header');
						return;
						}
						
						try {
						// Extract the expression after 'plural='
						const pluralExpr = pluralForm.split('plural=')[1].replace(/;$/, '');
						
						// Split into individual conditions
						const conditions = pluralExpr.split(/\s*:\s*/);
						
						// Process each condition
						const explanations = [];
						for (let i = 0; i < conditions.length; i++) {
						const [conditionPart, result] = conditions[i].split(/\s*\?\s*/);
						
						if (!conditionPart || result === undefined) {
						// Handle the final default case
						if (i === conditions.length - 1) {
						explanations.push(`Otherwise: ${conditions[i]}`);
						}
						continue;
						}
						
						if (equalityMatch) {
						explanations[parseInt(result)] = `n=${equalityMatch[1]}`;
						continue;
						}
						
						// Change: Return only the range for modulo conditions
						if (modRangeMatch) {
						const start = parseInt(modRangeMatch[2]);
						const end = parseInt(modRangeMatch[3]);
						explanations[parseInt(result)] = `[${start},${end}]`;
						continue;
						}
						
						// Change: Return only the range for direct conditions
						if (rangeMatch) {
						const start = parseInt(rangeMatch[1]);
						const end = parseInt(rangeMatch[2]);
						explanations[parseInt(result)] = `[${start},${end}]`;
						continue;
						}
						// Parse the condition
						const condition = conditionPart
						.replace(/\bn\b/g, 'n')
						.replace(/%/g, ' mod ')
						.replace(/&&/g, ' and ')
						.replace(/>=/g, '≥')
						.replace(/<=/g, '≤')
						.replace(/==/g, '=');
						
						explanations.push(`Form ${result}: ${condition}`);
						}
						
						console.log('Plural Forms Explanation:');
						console.log('-------------------------');
						explanations.forEach(explanation => console.log(explanation));
							
							} catch (error) {
							console.error('Error parsing plural form:', error);
							console.log('Raw plural form:', pluralForm);
							}
							}
							/**
							* Provides a comprehensive explanation of plural forms with example numbers
							* @param {string} pluralForm - The plural form string from the PO header
							*/
							function explainPluralFormComprehensively(pluralForm) {
							const explanations = [];
							if (!pluralForm) {
							console.log('No plural form found in PO file header');
							return explanations;
							}
							
							try {
							// Clean up plural form string
							pluralForm = pluralForm.replace(/"/g, '').replace(/\\n/g, '').trim();
							
							// Extract the expression after 'plural='
							const pluralExpr = pluralForm.split('plural=')[1].replace(/;$/, '');
							const conditions = pluralExpr.split(/\s*:\s*/);
							
							for (let i = 0; i < conditions.length; i++) {
							const [conditionPart, result] = conditions[i].split(/\s*\?\s*/);
							
							if (!conditionPart || result === undefined) {
							if (i === conditions.length - 1) {
							explanations[parseInt(conditions[i])] = 'Otherwise';
							}
							continue;
							}
							
							// Handle simple equality conditions (n == number)
							const equalityMatch = conditionPart.match(/n\s*==\s*(\d+)/);
							if (equalityMatch) {
							explanations[parseInt(result)] = `n=${equalityMatch[1]}`;
							continue;
							}
							
							// Handle modulo range conditions (n%100>=3 && n%100<=10)
								const modRangeMatch = conditionPart.match(/n%(\d+)\s*>=\s*(\d+)\s*&&\s*n%\d+\s*<=\s*(\d+)/);
									if (modRangeMatch) {
									const start = parseInt(modRangeMatch[2]);
									const end = parseInt(modRangeMatch[3]);
									explanations[parseInt(result)] = `[${start},${end}]`;
									continue;
									}
									
									// Handle direct range conditions (n>=3 && n<=10)
										const rangeMatch = conditionPart.match(/n\s*>=\s*(\d+)\s*&&\s*n\s*<=\s*(\d+)/);
											if (rangeMatch) {
											const start = parseInt(rangeMatch[1]);
											const end = parseInt(rangeMatch[2]);
											explanations[parseInt(result)] = `[${start},${end}]`;
											continue;
											}
											
											// Handle simple modulo conditions (n%10==1)
											const modEqualityMatch = conditionPart.match(/n%(\d+)\s*==\s*(\d+)/);
											if (modEqualityMatch) {
											const mod = parseInt(modEqualityMatch[1]);
											const value = parseInt(modEqualityMatch[2]);
											explanations[parseInt(result)] = `n%${mod}=${value}`;
											continue;
											}
											
											// Default case - return raw condition
											explanations[parseInt(result)] = conditionPart
											.replace(/\bn\b/g, 'n')
											.replace(/%/g, ' mod ')
											.replace(/&&/g, ' and ');
											}
											
											} catch (error) {
											console.error('Error parsing plural form:', error);
											console.log('Raw plural form:', pluralForm);
											}
											return explanations;
											}
											
											/**
											* Extracts PO file strings and metadata
											* @param {string} poContent - The content of the PO file
											* @returns {Object} Extraction result with messages, metadata and header block
											*/
											function extractPoStrings(poContent) {
											const lines = poContent.split('\n');
											let currentMsg = null;
											const messages = [];
											
											// Improved header detection logic
											let headerEndIndex = 0;
											let inHeader = true;
											let headerEndFound = false;
											
											// Identify header section boundaries
											for (; headerEndIndex < lines.length; headerEndIndex++) {
											const line = lines[headerEndIndex].trim();
											if (!line) {
											if (inHeader) {
											headerEndFound = true;
											break;
											}
											continue;
											}
											
											// Detect first non-header msgid entry
											if (line.startsWith('msgid ') && line !== 'msgid ""') {
											inHeader = false;
											headerEndFound = true;
											break;
											}
											}
											
											// Fallback if header boundary wasn't detected
											if (!headerEndFound) {
											headerEndIndex = lines.length;
											}
											
											// Extract header block
											const headerBlock = lines.slice(0, headerEndIndex).join('\n');
											window.currentHeaderBlock = headerBlock;
											
											let pendingComments = [];   // Accumulates translator comments
											let pendingReferences = []; // Accumulates reference locations
											let inPluralBlock = false;
											
											// Process each line after header
											for (let lineNumber = headerEndIndex; lineNumber < lines.length; lineNumber++) {
											const line = lines[lineNumber];
											const trimmedLine = line.trim();
											
											if (!trimmedLine) continue; // Skip empty lines
											
											// Handle msgid declarations
											if (trimmedLine.startsWith('msgid ') || trimmedLine.startsWith('#~ msgid ')) {
											// Save previous message if exists
											if (currentMsg) {
											messages.push(currentMsg);
											}
											
											const isObsolete = trimmedLine.startsWith('#~');
											const startQuote = trimmedLine.indexOf('"');
											const endQuote = trimmedLine.lastIndexOf('"');
											let text = '';
											
											if (startQuote !== -1 && endQuote > startQuote) {
												text = trimmedLine.substring(startQuote + 1, endQuote);
												}
												
												currentMsg = {
												id: `msg-${messages.length + 1}`,
												isObsolete,
												fuzzy: false,
												msgid: text,
												msgstr: '',
												references: [...pendingReferences],
												comments: [...pendingComments],
												lineNumber: lineNumber + 1,
												complete: false,
												hasPlural: false
												};
												// Reset accumulators
												pendingComments = [];
												pendingReferences = [];
												inPluralBlock = false;
												}
												// Handle msgid_plural declarations
												else if (trimmedLine.startsWith('msgid_plural ') || trimmedLine.startsWith('#~ msgid_plural ')) {
												if (!currentMsg) continue;
												
												const isObsolete = trimmedLine.startsWith('#~');
												const startQuote = trimmedLine.indexOf('"');
												const endQuote = trimmedLine.lastIndexOf('"');
												let text = '';
												
												if (startQuote !== -1 && endQuote > startQuote) {
												text = trimmedLine.substring(startQuote + 1, endQuote);
												}
												
												currentMsg.hasPlural = true;
												currentMsg.msgid_plural = text;
												inPluralBlock = true;
												}
												// Handle msgstr declarations
												else if (trimmedLine.startsWith('msgstr ') || trimmedLine.startsWith('#~ msgstr ')) {
												if (!currentMsg) continue;
												
												if (inPluralBlock) {
												// This is msgstr[0] for plural forms
												const startQuote = trimmedLine.indexOf('"');
												const endQuote = trimmedLine.lastIndexOf('"');
												if (startQuote !== -1 && endQuote > startQuote) {
												currentMsg.msgstr = [trimmedLine.substring(startQuote + 1, endQuote)];
												}
												} else {
												// Regular msgstr handling
												const startQuote = trimmedLine.indexOf('"');
												const endQuote = trimmedLine.lastIndexOf('"');
												if (startQuote !== -1 && endQuote > startQuote) {
												currentMsg.msgstr = trimmedLine.substring(startQuote + 1, endQuote);
												}
												}
												currentMsg.complete = true;
												}
												// Handle msgstr[n] declarations for plural forms
												else if ((trimmedLine.startsWith('msgstr[') || trimmedLine.startsWith('#~ msgstr[')) && currentMsg?.hasPlural) {
												const startBracket = trimmedLine.indexOf('[');
												const endBracket = trimmedLine.indexOf(']');
												const index = parseInt(trimmedLine.substring(startBracket + 1, endBracket));
												
												const startQuote = trimmedLine.indexOf('"');
												const endQuote = trimmedLine.lastIndexOf('"');
												if (startQuote !== -1 && endQuote > startQuote) {
												const text = trimmedLine.substring(startQuote + 1, endQuote);
												if (!Array.isArray(currentMsg.msgstr)) {
												currentMsg.msgstr = [];
												}
												currentMsg.msgstr[index] = text;
												}
												}
												// Handle multiline string continuations
												else if (currentMsg && trimmedLine.endsWith('"') && 
												(trimmedLine.startsWith('"') || 
												(currentMsg.isObsolete && trimmedLine.startsWith('#~ "')))) {
												
												let content;
												if (trimmedLine.startsWith('"')) {
												content = trimmedLine.substring(1, trimmedLine.length - 1);
												} else {
												// FIX: Use substring(4) instead of substring(3) to remove '#~ "' completely
												content = trimmedLine.substring(4, trimmedLine.length - 1);
												}
												
												if (currentMsg.complete) {
												if (Array.isArray(currentMsg.msgstr)) {
												if (currentMsg.msgstr.length > 0) {
												currentMsg.msgstr[currentMsg.msgstr.length - 1] += content;
												}
												} else {
												currentMsg.msgstr += content;
												}
												} else {
												if (currentMsg.hasPlural && inPluralBlock) {
												currentMsg.msgid_plural += content;
												} else {
												currentMsg.msgid += content;
												}
												}
												}
												// Capture reference locations
												else if (trimmedLine.startsWith('#:')) {
												pendingReferences.push(line);
												}
												// Capture translator comments
												else if (trimmedLine.startsWith('#.')) {
												pendingComments.push(line);
												}
												// Fuzzy Flag Detection
												else if (trimmedLine.startsWith('#, fuzzy') || trimmedLine.includes('fuzzy')) {
												currentMsg.fuzzy = true;
												pendingComments.push(line);
												}
												// Capture other comments (excluding obsolete markers)
												else if (trimmedLine.startsWith('#') && !trimmedLine.startsWith('#~')) {
												pendingComments.push(line);
												}
												}
												
												// Add final message if exists
												if (currentMsg) {
												messages.push(currentMsg);
												}
												
												// Store messages and metadata globally
												window.currentMessages = messages;
												window.currentMetadata = extractMetadata(poContent);
												
												return {
												messages: messages,
												metadata: window.currentMetadata,
												headerBlock: headerBlock
												};
												}
												
												/**
												* Extracts metadata from PO file headers
												* @param {string} poContent - The full PO file content
												* @returns {Object} Key-value pairs of metadata
												*/
												function extractMetadata(poContent) {
												const metadata = {};
												const headerEnd = poContent.indexOf('msgid ""');
												if (headerEnd === -1) return metadata;
												
												const headerSection = poContent.substring(0, headerEnd);
												const headerLines = headerSection.split('\n');
												
												// Parse each metadata line
												for (const line of headerLines) {
												if (line.startsWith('"')) {
												const parts = line.split(':');
												if (parts.length >= 2) {
												const key = parts[0].replace(/"/g, '').trim();
												const value = parts.slice(1).join(':').replace(/\\n/g, '').replace(/"/g, '').trim();
												if (key && value) {
												metadata[key] = value;
												}
												}
												}
												}
												
												return metadata;
												}
												
												/**
												* Generates translated PO file content from messages
												* @param {Array} messages - Message objects with translations
												* @param {Object} metadata - File metadata
												* @returns {string} Complete PO file content with translations
												*/
												function generateTranslatedPo(messages, metadata) {
												let header = window.currentHeaderBlock;
												const langCode = document.getElementById('targetLang').value;
												
												header = header.replace(
												/("Language: )\w+(\\n")/,
												`$1${langCode}$2`
												);
												
												let output = [];
												output.push(header);
												output.push('');
												
												messages.forEach(msg => {
												if (msg.msgid === '') return;
												
												/* msg.references.forEach(ref => output.push(ref));
												msg.comments.forEach(comment => output.push(comment)); */
												// Separate translator comments (#.) from other comments
												const translatorComments = msg.comments.filter(c => c.trim().startsWith('#.'));
												const otherComments = msg.comments.filter(c => !c.trim().startsWith('#.'));
												
												// Output comments in correct order: translator comments first, then references, then other comments
												translatorComments.forEach(comment => output.push(comment));
												msg.references.forEach(ref => output.push(ref));
												otherComments.forEach(comment => output.push(comment));
												
												if (msg.isObsolete) {
												output.push('#~ msgid "' + msg.msgid + '"');
												if (msg.hasPlural) {
												output.push('#~ msgid_plural "' + (msg.msgid_plural || '') + '"');
												if (Array.isArray(msg.msgstr)) {
												msg.msgstr.forEach((str, index) => {
												output.push('#~ msgstr[' + index + '] "' + (str || '') + '"');
												});
												}
												} else {
												output.push('#~ msgstr "' + (msg.msgstr || '') + '"');
												}
												} else {
												output.push('msgid "' + msg.msgid + '"');
												if (msg.hasPlural) {
												output.push('msgid_plural "' + (msg.msgid_plural || '') + '"');
												if (Array.isArray(msg.msgstr)) {
												msg.msgstr.forEach((str, index) => {
												output.push('msgstr[' + index + '] "' + (str || '') + '"');
												});
												}
												} else {
												output.push('msgstr "' + (msg.msgstr || '') + '"');
												}
												}
												if (msg.fuzzy && !msg.isObsolete) {
												output.push('#, fuzzy');
												}
												output.push('');
												});
												
												return output.join('\n');
												}
												/**
												* Displays extracted strings in a translation table
												* @param {Object} result - Extraction result object
												* @param {boolean} [forceRefresh=true] - Whether to force UI refresh
												*/
												function displayExtractedStrings(result, forceRefresh = true) {
												const { messages, metadata } = result;
												
												// Update statistics display
												sourceStats.innerHTML = `
												<p>Total strings: ${messages.length}</p>
												<p>Translated: ${messages.filter(m => m.msgstr).length}</p>
												<p>Obsolete: ${messages.filter(m => m.isObsolete).length}</p>
												`;
												
												// Construct table HTML structure
												let tableHTML = `
												<div class="translation-table-container">
													<table class="translation-table">
														<thead>
															<tr>
																<th>ID</th>
																<th>Context</th>
																<th>Original Text</th>
																<th>Plural Text</th>
																<th>Translation</th>
																<th>Plural Translations</th>
																<th>Status</th>
																<th>Fuzzy</th>
															</tr>
														</thead>
														<tbody>
															`;
															
															// Process each message for table rows
															messages.forEach(msg => {
															if (msg.msgid === '') return;
															
															const status = msg.msgstr ? 'Translated' : msg.isObsolete ? 'Obsolete' : 'Untranslated';
															const statusClass = msg.msgstr ? 'translated' : msg.isObsolete ? 'obsolete' : 'untranslated';
															
															const contextLines = [];
															
															msg.references.forEach(ref => {
															let cleanRef = ref.replace(/^#:\s*/, '');
															contextLines.push(`<span class="reference">${escapeHtml(cleanRef)}</span>`);
															});
															
															msg.comments.forEach(comment => {
															let cleanComment = comment.replace(/^#\.?\s*/, '');
															if (comment.startsWith('#')) {
															contextLines.push(`<span class="comment">${escapeHtml(cleanComment)}</span>`);
															} else {
															contextLines.push(`<span class="other-comment">${escapeHtml(cleanComment)}</span>`);
															}
															});
															
															const contextHtml = contextLines.join('<br>') || 'No context';
															const rowClass = `${statusClass} ${msg.fuzzy ? 'fuzzy' : ''}`;
															
															// Handle plural forms
															let pluralTranslationsHtml = '';
															if (msg.hasPlural && Array.isArray(msg.msgstr)) {
															pluralTranslationsHtml = `<div class="plural-translations">`;
																msg.msgstr.forEach((translation, index) => {
																let explanation = window.pluralFormsExplanations?.[index] || `Form ${index}`;
																
																// Change: Remove the prefix text for ranges
																if (explanation.startsWith('[')) {
																// Keep only the range part
																explanation = explanation;
																} else if (explanation.includes('n=')) {
																// Keep only the n=value part
																explanation = explanation.split('n=')[1];
																}
																
																pluralTranslationsHtml += `
																<div class="plural-form">
																	<div class="plural-header">
																		<span class="plural-index">[${index}]:</span>
																		<span class="plural-explanation">${escapeHtml(explanation)}</span>
																	</div>
																	<span class="plural-text" contenteditable="true">${escapeHtml(translation || '')}</span>
																</div>
																`;
																});
															pluralTranslationsHtml += `</div>`;
															}
															
															tableHTML += `
															<tr data-id="${msg.id}" class="${rowClass}">
																<td>${msg.id}</td>
																<td class="context-cell">${contextHtml}</td>
																<td class="original-text">${escapeHtml(msg.msgid)}</td>
																<td class="original-plural">${msg.hasPlural ? escapeHtml(msg.msgid_plural) : ''}</td>
																<td class="translation-cell" contenteditable="true">${msg.hasPlural ? '' : escapeHtml(msg.msgstr)}</td>
																<td class="plural-translations-cell">${pluralTranslationsHtml}</td>
																<td class="status">${status}</td>
																<td class="fuzzy-status">${msg.fuzzy ? 'Yes' : 'No'}</td>
															</tr>
															`;
															});
															
															tableHTML += `
														</tbody>
													</table>
												</div>
												`;
												
												translationTableContainer.innerHTML = tableHTML;
												
												document.querySelectorAll('.translation-cell').forEach(cell => {
												cell.addEventListener('blur', function() {
												const row = this.closest('tr');
												const msgId = row.dataset.id;
												const newTranslation = this.textContent;
												
												const message = messages.find(m => m.id === msgId);
												if (message && !message.hasPlural) {
												message.msgstr = newTranslation;
												updateRowStatus(row, newTranslation);
												}
												});
												});
												
												document.querySelectorAll('.plural-text').forEach(cell => {
												cell.addEventListener('blur', function() {
												const row = this.closest('tr');
												const msgId = row.dataset.id;
												const pluralIndex = parseInt(this.closest('.plural-form').querySelector('.plural-index').textContent.match(/\d+/)[0]);
												const newTranslation = this.textContent;
												
												const message = messages.find(m => m.id === msgId);
												if (message && message.hasPlural && Array.isArray(message.msgstr)) {
												message.msgstr[pluralIndex] = newTranslation;
												updateRowStatus(row, newTranslation);
												}
												});
												});
												}
												
												/**
												* Updates row status based on translation content
												* @param {HTMLElement} row - Table row element
												* @param {string} translation - Current translation text
												*/
												function updateRowStatus(row, translation) {
												const statusCell = row.querySelector('.status');
												if (translation.trim()) {
												row.classList.add('translated');
												row.classList.remove('untranslated');
												statusCell.textContent = 'Translated';
												} else {
												row.classList.add('untranslated');
												row.classList.remove('translated');
												statusCell.textContent = 'Untranslated';
												}
												}
												
												/**
												* Escapes HTML special characters for safe display
												* @param {string} unsafe - Raw input string
												* @returns {string} HTML-safe string
												*/
												function escapeHtml(unsafe) {
												if (!unsafe) return '';
												return unsafe
												.replace(/&/g, "&amp;")
												.replace(/</g, "&lt;")
												.replace(/>/g, "&gt;")
												.replace(/"/g, "&quot;")
												.replace(/'/g, "&#039;")
												.replace(/\n/g, '<br>');
												}
												
												/**
												* Controls visibility of loading indicator
												* @param {boolean} show - Whether to show the indicator
												*/
												function showLoading(show) {
												loadingIndicator.style.display = show ? 'flex' : 'none';
												}
												function refreshTranslationTable() {
												if (!window.currentMessages) return;
												displayExtractedStrings({
												messages: window.currentMessages,
												metadata: window.currentMetadata
												}, true);
												}
												/**
												* Performs comprehensive analysis comparing original and translated PO files
												*/
												function performAnalysis() {
												const modal = document.getElementById('analysisModal'); // Get modal here
												const originalContent = sourceText.value.trim();
												const translatedContent = translatedText.value.trim();
												
												if (!originalContent || !translatedContent) {
												alert('Both original and translated content are required for analysis');
												return;
												}
												
												showLoading(true);
												
												setTimeout(() => {
												try {
												const originalData = extractPoStrings(originalContent);
												const translatedData = extractPoStrings(translatedContent);
												
												const originalStats = generateStatistics(originalData.messages);
												const translatedStats = generateStatistics(translatedData.messages);
												
												displayAnalysisReport(originalStats, translatedStats);
												modal.style.display = 'block';
												
												// Display modal if it exists
												if (modal) {
												displayAnalysisReport(originalStats, translatedStats);
												modal.style.display = 'block';
												}
												} catch (error) {
												console.error('Analysis error:', error);
												alert('Error performing analysis: ' + error.message);
												} finally {
												showLoading(false);
												}
												}, 100);
												}
												
												/**
												* Generates statistics from PO messages
												* @param {Array} messages - Message objects
												* @returns {Object} Statistics object
												*/
												function generateStatistics(messages) {
												const stats = {
												total: 0,
												translated: 0,
												untranslated: 0,
												fuzzy: 0,
												obsolete: 0,
												withPlurals: 0,
												withContext: 0,
												charCount: 0,
												wordCount: 0
												};
												
												messages.forEach(msg => {
												if (msg.msgid === '') return;
												
												stats.total++;
												
												if (msg.isObsolete) {
												stats.obsolete++;
												return;
												}
												
												if (msg.fuzzy) stats.fuzzy++;
												
												if (msg.hasPlural) stats.withPlurals++;
												
												if (msg.references.length > 0 || msg.comments.length > 0) {
												stats.withContext++;
												}
												
												// Calculate translation status
												if (msg.hasPlural) {
												if (Array.isArray(msg.msgstr)) {
												const allTranslated = msg.msgstr.every(t => t && t.trim() !== '');
												if (allTranslated) {
												stats.translated++;
												} else {
												stats.untranslated++;
												}
												} else {
												stats.untranslated++;
												}
												} else {
												if (msg.msgstr && msg.msgstr.trim() !== '') {
												stats.translated++;
												} else {
												stats.untranslated++;
												}
												}
												
												// Calculate text metrics
												const text = msg.msgid + (msg.msgid_plural || '');
												stats.charCount += text.length;
												stats.wordCount += text.split(/\s+/).filter(w => w).length;
												});
												
												return stats;
												}
												
												/**
												* Displays analysis report in modal
												* @param {Object} origStats - Original file statistics
												* @param {Object} transStats - Translated file statistics
												*/
												function displayAnalysisReport(origStats, transStats) {
												const report = document.getElementById('analysisReport');
												if (!report) {
												console.error('Analysis report element not found');
												return;
												}
												
												// Calculate progress percentages
												const origTranslatedPct = Math.round((origStats.translated / origStats.total) * 100);
												const transTranslatedPct = Math.round((transStats.translated / transStats.total) * 100);
												const improvementPct = transTranslatedPct - origTranslatedPct;
												
												const origFuzzyPct = Math.round((origStats.fuzzy / origStats.total) * 100);
												const transFuzzyPct = Math.round((transStats.fuzzy / transStats.total) * 100);
												
												const origUntranslatedPct = Math.round((origStats.untranslated / origStats.total) * 100);
												const transUntranslatedPct = Math.round((transStats.untranslated / transStats.total) * 100);
												
												// Create report HTML
												report.innerHTML = `
												<div class="stats-grid">
													<div class="stat-card">
														<h4>Translation Progress</h4>
														<p><strong>Original:</strong> ${origStats.translated}/${origStats.total} (${origTranslatedPct}%)</p>
														<div class="progress-container">
															<div class="progress-bar" style="width:${origTranslatedPct}%">${origTranslatedPct}%</div>
														</div>
														<p><strong>Translated:</strong> ${transStats.translated}/${transStats.total} (${transTranslatedPct}%)</p>
														<div class="progress-container">
															<div class="progress-bar" style="width:${transTranslatedPct}%">${transTranslatedPct}%</div>
														</div>
														<p><strong>Improvement:</strong> ${improvementPct}%</p>
													</div>
													
													<div class="stat-card">
														<h4>Fuzzy Status</h4>
														<p><strong>Original:</strong> ${origStats.fuzzy} (${origFuzzyPct}%)</p>
														<p><strong>Translated:</strong> ${transStats.fuzzy} (${transFuzzyPct}%)</p>
														<p><strong>Change:</strong> ${transStats.fuzzy - origStats.fuzzy}</p>
													</div>
													
													<div class="stat-card">
														<h4>Untranslated</h4>
														<p><strong>Original:</strong> ${origStats.untranslated} (${origUntranslatedPct}%)</p>
														<p><strong>Translated:</strong> ${transStats.untranslated} (${transUntranslatedPct}%)</p>
														<p><strong>Remaining:</strong> ${transStats.untranslated}</p>
													</div>
												</div>
												
												<div class="report-section">
													<h4>Detailed Comparison</h4>
													<table class="report-table">
														<thead>
															<tr>
																<th>Metric</th>
																<th>Original</th>
																<th>Translated</th>
																<th>Difference</th>
															</tr>
														</thead>
														<tbody>
															<tr>
																<td>Total Messages</td>
																<td>${origStats.total}</td>
																<td>${transStats.total}</td>
																<td>${transStats.total - origStats.total}</td>
															</tr>
															<tr>
																<td>Translated Messages</td>
																<td>${origStats.translated}</td>
																<td>${transStats.translated}</td>
																<td>${transStats.translated - origStats.translated}</td>
															</tr>
															<tr>
																<td>Untranslated Messages</td>
																<td>${origStats.untranslated}</td>
																<td>${transStats.untranslated}</td>
																<td>${transStats.untranslated - origStats.untranslated}</td>
															</tr>
															<tr>
																<td>Fuzzy Messages</td>
																<td>${origStats.fuzzy}</td>
																<td>${transStats.fuzzy}</td>
																<td>${transStats.fuzzy - origStats.fuzzy}</td>
															</tr>
															<tr>
																<td>Obsolete Messages</td>
																<td>${origStats.obsolete}</td>
																<td>${transStats.obsolete}</td>
																<td>${transStats.obsolete - origStats.obsolete}</td>
															</tr>
															<tr>
																<td>Messages with Plurals</td>
																<td>${origStats.withPlurals}</td>
																<td>${transStats.withPlurals}</td>
																<td>${transStats.withPlurals - origStats.withPlurals}</td>
															</tr>
															<tr>
																<td>Messages with Context</td>
																<td>${origStats.withContext}</td>
																<td>${transStats.withContext}</td>
																<td>${transStats.withContext - origStats.withContext}</td>
															</tr>
															<tr>
																<td>Total Characters</td>
																<td>${origStats.charCount}</td>
																<td>${transStats.charCount}</td>
																<td>${transStats.charCount - origStats.charCount}</td>
															</tr>
															<tr>
																<td>Total Words</td>
																<td>${origStats.wordCount}</td>
																<td>${transStats.wordCount}</td>
																<td>${transStats.wordCount - origStats.wordCount}</td>
															</tr>
														</tbody>
													</table>
												</div>
												
												<div class="report-section">
													<h4>Translation Quality Indicators</h4>
													<p><strong>Completeness:</strong> ${transTranslatedPct >= 95 ? '✅ Excellent' : transTranslatedPct >= 80 ? '⚠️ Good' : '❌ Needs Work'}</p>
													<p><strong>Fuzzy Reduction:</strong> ${transStats.fuzzy < origStats.fuzzy ? '✅ Improved' : '⚠️ Needs Attention'}</p>
														<p><strong>Context Preservation:</strong> ${transStats.withContext === origStats.withContext ? '✅ Maintained' : '⚠️ Changed'}</p>
													</div>
													`;
													}	
													</script>
												</body>
											</html>											